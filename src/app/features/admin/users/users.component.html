<div class="users-container">
  <p-toast />
  <p-confirmDialog />

  <div class="card">
    <p-toolbar>
      <div class="p-toolbar-group-start">
        <h2 class="text-2xl font-bold m-0">User Management</h2>
      </div>
      <div class="p-toolbar-group-end">
        <p-button
          label="Add User"
          icon="pi pi-plus"
          (click)="openNew()"
        />
      </div>
    </p-toolbar>

   
    <p-table
      #dt
      [value]="filteredData()"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [globalFilterFields]="['firstName', 'lastName', 'email', 'phone']"
      [tableStyle]="{ 'min-width': '50rem' }"
      [paginator]="true"
      [showCurrentPageReport]="true"
      [currentPageReportTemplate]="'Showing {first} to {last} of {totalRecords} entries'"
      [rowHover]="true"
      dataKey="id"
      [loading]="loading()"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="name">
            Name <p-sortIcon field="name" />
          </th>
          <th pSortableColumn="email">
            Email <p-sortIcon field="email" />
          </th>
          <th pSortableColumn="lastLogin">
            Last Login <p-sortIcon field="lastLogin" />
          </th>
          <th pSortableColumn="device">
            Device <p-sortIcon field="device" />
          </th>
          <th pSortableColumn="status">
            Device status <p-sortIcon field="status" />
          </th>
          <th pSortableColumn="acceptedTerms">
            Accepted terms <p-sortIcon field="acceptedTerms" />
          </th>
          <th pSortableColumn="phase">
            Phase <p-sortIcon field="phase"/></th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-user>
        <tr>
          <td>{{ user.firstName }} {{ user.lastName }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.lastLogin }}</td>
          <td>{{ user.device }}</td>
          <td>
            <p-tag [value]="user.status" [severity]="user.status === 'Active' ? 'success' : 'danger'"></p-tag>
          </td>
          <td>{{ user.acceptedTerms }}</td>
          <td>{{ user.phase}}</td>
          <td>
            <div class="action-buttons">
              <p-button
                icon="pi pi-pencil"
                (click)="editUser(user)"
                styleClass="p-button-text p-button-rounded p-button-success"
                [pTooltip]="'Edit'"
                pTooltipPosition="top"
              />
              <p-button
                icon="pi pi-trash"
                (click)="deleteUser(user)"
                styleClass="p-button-text p-button-rounded p-button-danger"
                [pTooltip]="'Delete'"
                pTooltipPosition="top"
              />
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center p-4">
            <p class="text-gray-500">No users found</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-dialog
    [(visible)]="displayDialog"
    [modal]="true"
    [style]="{ width: '800px' }"
    [closable]="false"
    (onHide)="onDialogHide()"
  >
    <ng-template pTemplate="header">
      <div class="flex items-center gap-3">
        <button 
          type="button"
          class="border-none bg-transparent cursor-pointer p-1 text-gray-600 hover:text-gray-800"
          (click)="displayDialog.set(false)"
          aria-label="Back"
        >
          <i class="pi pi-arrow-left"></i>
        </button>
        <h3 class="m-0 text-2xl font-semibold">{{ editingUser() ? 'Edit User' : 'Add User' }}</h3>
      </div>
    </ng-template>

    <form [formGroup]="userForm">
      <div class="flex flex-row gap-6">
        <div class="flex-1 flex flex-col gap-5">
          <div class="flex flex-col gap-2">
            <label for="firstName" class="text-sm font-medium text-gray-700">First name <span class="text-red-500">*</span></label>
            <input
              id="firstName"
              type="text"
              pInputText
              formControlName="firstName"
              placeholder="Input first name"
              class="w-full"
              [validationError]="{required: 'First Name is required'}"
            />
          </div>

          <div class="flex flex-col gap-2">
            <label for="role" class="text-sm font-medium text-gray-700">User role <span class="text-red-500">*</span></label>
            <p-select
              id="role"
              [options]="roles()"
              formControlName="role"
              placeholder="Select"
              class="w-full"
              [validationError]="{required: 'User role is required'}"
            />
          </div>

          <div class="flex flex-col gap-2">
            <label for="email" class="text-sm font-medium text-gray-700">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              id="email"
              type="email"
              pInputText
              formControlName="email"
              placeholder="email"
              class="w-full"
              [validationError]="{required: 'Email is required', email: 'Invalid email format'}"
            />
          </div>
        </div>

        <div class="flex-1 flex flex-col gap-5">
          <div class="flex flex-col gap-2">
            <label for="lastName" class="text-sm font-medium text-gray-700">Last name <span class="text-red-500">*</span></label>
            <input
              id="lastName"
              type="text"
              pInputText
              formControlName="lastName"
              placeholder="Input last name"
              class="w-full"
              [validationError]="{required: 'Last Name is required'}"
            />
          </div>

          <div class="flex flex-col gap-2">
            <label for="department" class="text-sm font-medium text-gray-700">Company <span class="text-red-500">*</span></label>
            <p-select
              id="department"
              [options]="departments()"
              formControlName="department"
              placeholder="Select"
              class="w-full"
              [validationError]="{required: 'Company is required'}"
            />
          </div>

          <div class="flex flex-col gap-2">
            <label for="phone" class="text-sm font-medium text-gray-700">Phone number <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <p-select
                id="phoneCountryCode"
                [options]="countryCodes()"
                formControlName="phoneCountryCode"
                class="w-32"
                [validationError]="{required: 'Country code is required'}"
              />
              <input
                id="phone"
                type="text"
                pInputText
                formControlName="phone"
                placeholder="Input"
                class="flex-1"
                [validationError]="{required: 'Phone number is required', phone: 'Invalid phone number'}"
              />
            </div>
          </div>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        severity="contrast"
        outlined
        (click)="displayDialog.set(false)"
        styleClass="p-button-text"
      />
      <p-button
        label="Save"
        severity="success"
        (click)="saveUser()"
        [disabled]="userForm.invalid"
      />
    </ng-template>
  </p-dialog>
</div>

